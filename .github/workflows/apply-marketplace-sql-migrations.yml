name: Apply Marketplace SQL Migrations

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/apply-marketplace-sql-migrations.yml"
      - "ark-sqlx/**"

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    name: Discord Notification
    steps:
      - name: Send notification to dev-updates channel
        run: |
          curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                  "content": "üóÉÔ∏è Running SQL migrations `/migrations/marketplace` on Mainnet database..."
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

  run-migrations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [mainnet]
    name: Run SQL Migrations on ${{ matrix.environment }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli jq
          cargo install sqlx-cli --no-default-features --features rustls,postgres

      - name: Run SQL Migrations
        run: |
          echo "::add-mask::$DATABASE_URL"
          cd ark-sqlx
          sqlx migrate run --source ./migrations/marketplace
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
