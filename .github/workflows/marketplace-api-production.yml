name: MKT API (Production) (Mainnet) (Scaleway)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/marketplace-api-production.yml"
      - "ark-marketplace-api/**"
      - "ark-sqlx/providers/marketplace/**"

jobs:
  discord-notification:
    runs-on: ubuntu-latest
    name: Discord Notification
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notification to dev-updates channel
        uses: ./.github/actions/discord-notification
        with:
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          message: "🚢 Deploying Marketplace API to Mainnet environment..."

  deploy-to-scaleway:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SCALEWAY_MARKETPLACE_API_SSH_KEY }}

      - name: Apply Marketplace SQL Migrations
        uses: ./.github/actions/marketplace-sql-migrations
        with:
          discord-webhook-url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          database-url: ${{ secrets.DATABASE_URL }}

      - name: Deploy to Scaleway
        run: |
          ssh -o StrictHostKeyChecking=no github@${{ secrets.SCALEWAY_MARKETPLACE_API_IP }} "sudo systemctl restart ark-marketplace-api-docker.service && sleep 10"

      - name: Verify Deployment
        run: |
          ssh -o StrictHostKeyChecking=no github@${{ secrets.SCALEWAY_MARKETPLACE_API_IP }} << EOF
            sudo systemctl status ark-marketplace-api-docker.service
            docker logs marketplace-api --tail 50
          EOF

      - name: Send success notification to dev-updates channel
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                  "content": "✅ Successfully deployed Marketplace API to Production environment."
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      - name: Send failure notification to dev-updates channel
        if: failure()
        run: |
          curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                  "content": "❌ Failed to deploy Marketplace API to Production environment. Check the logs [here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})."
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}
