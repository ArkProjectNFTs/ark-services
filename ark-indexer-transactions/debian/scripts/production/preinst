#!/bin/sh
# preinst script for ark-indexer-transactions-production
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <new-preinst> `install'
#        * <new-preinst> `install' <old-version>
#        * <new-preinst> `upgrade' <old-version>
#        * <old-preinst> `abort-upgrade' <new-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    install|upgrade)
        mkdir -p /etc/ark-project
        mkdir -p /opt/starknet-sequencer/mainnet/state

        CONFIG_FILE="/etc/ark-project/transaction.config.production.yml"

        if [ -f "$CONFIG_FILE" ]; then
            echo "Patching existing $CONFIG_FILE..."

            grep -q "^database_url:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'database_url: "postgres://user:database@localhost/arkproject"' >> "$CONFIG_FILE"
            fi

            # Add log_level if it does not exist
            grep -q "^log_level:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'log_level: "info"' >> "$CONFIG_FILE"
            fi

            grep -q "^rcp_provider:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'rcp_provider: "https://juno.mainnet.arkproject.dev/v0_7"' >> "$CONFIG_FILE"
            fi

            grep -q "^base_path:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'base_path: "/opt/fast-indexer/blocks"' >> "$CONFIG_FILE"
            fi

            grep -q "^parsing_state_path:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'parsing_state_path: "/opt/starknet-sequencer/mainnet/state"' >> "$CONFIG_FILE"
            fi

            grep -q "^chain_id:" "$CONFIG_FILE"
            if [ $? -ne 0 ]; then
                echo 'chain_id: "0x534e5f4d41494e"' >> "$CONFIG_FILE"
            fi

        else
            # Create the config file with default values if it doesn't exist
            echo "Creating $CONFIG_FILE with default values..."
            cat <<EOF > "$CONFIG_FILE"
database_url: "postgres://user:database@localhost/arkproject"
log_level: "info"
rcp_provider: "https://juno.mainnet.arkproject.dev/v0_7"
base_path: "/opt/fast-indexer/blocks"
parsing_state_path: "/opt/starknet-sequencer/mainnet/state"
chain_id: "0x534e5f4d41494e"
start_from: 0
EOF
        fi
    ;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0